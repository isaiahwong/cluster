apiVersion: v1
kind: Namespace
metadata:
  name: gateway-webhook
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: webhook-env-configmap
  namespace: gateway-webhook
data:
  NODE_ENV: "development"
  PORT: "8443"
  # store in secrets in production
  WEBHOOK_SECRET_KEY: UVNYdEVhRGxYWjZDaUh1bFdaNkZwUmVTMlExM2pEcGpqTG1HRDcwYlNnUUlEQVFBQg== 
  GATEWAY_SERVICE: gateway-service.default.svc.cluster.local:50051
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webhook-server
  namespace: gateway-webhook
  labels:
    app: webhook-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: webhook-server
  template:
    metadata:
      labels:
        app: webhook-server
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1234
      containers:
      - name: server
        image: registry.gitlab.com/isaiahwong/cluster/api/gateway/webhook
        imagePullPolicy: IfNotPresent

        ports:
        - containerPort: 8443
          name: webhook-api

        volumeMounts:
        - name: webhook-tls-certs
          mountPath: /run/secrets/tls
          readOnly: true

        envFrom:
        - configMapRef:
            name: webhook-env-configmap

      volumes:
      - name: webhook-tls-certs
        secret:
          secretName: webhook-server-tls
---
apiVersion: v1
kind: Service
metadata:
  name: webhook-server
  namespace: gateway-webhook
spec:
  selector:
    app: webhook-server
  ports:
    - port: 443
      targetPort: webhook-api
---
apiVersion: admissionregistration.k8s.io/v1beta1
kind: MutatingWebhookConfiguration
metadata:
  name: demo-webhook
webhooks:
  - name: webhook-server.gateway-webhook.svc
    clientConfig:
      service:
        name: webhook-server
        namespace: gateway-webhook
        path: "/webhook"
      caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMwRENDQWJnQ0NRRDNYZkRyVVpKOVd6QU5CZ2txaGtpRzl3MEJBUXNGQURBcU1TZ3dKZ1lEVlFRRERCOUIKWkcxcGMzTnBiMjRnUTI5dWRISnZiR3hsY2lCWFpXSm9iMjlySUVOQk1CNFhEVEU1TURrd01qQTVNamMxTlZvWApEVEU1TVRBd01qQTVNamMxTlZvd0tqRW9NQ1lHQTFVRUF3d2ZRV1J0YVhOemFXOXVJRU52Ym5SeWIyeHNaWElnClYyVmlhRzl2YXlCRFFUQ0NBU0l3RFFZSktvWklodmNOQVFFQkJRQURnZ0VQQURDQ0FRb0NnZ0VCQUxxb1R6R2EKVXlSbkNSQVRib3VSL1BJbTN5R1FCczVMQkVPaEt6ak8wbVBTYitYQjlDK2l3dEF6U1NlMGxLUmtWNnJCSk9UbQp6NUFwVXhmV05CQzc0M0Zibi9LTnkxSXFyK0MrdXNVWFZCVzZ3TkZnNEQvZ0M0VEwwUDZSWFVPVVVkbkxSYnhTClFLNmh5cWpWQjllb2ZPRlVLdWE2MFJWcGhmSk1KQjAvZVN3ZlRCT0FleXZpNWJ0MjRJdDFEc2FYbWxEdkxLSjQKR1VCY2V0RFh4bisrYis3QTdLVk5QZmJ6ek1QeHdQWnF1eWJVRk12akFndXJ2UGtTQWJXZGVTMnZkbStheVAwMgpuWHNOeUliYkMzcWFrS0JqZlpoNnpueXFpUnZrNDRMOC9yZlNsMWQ4NmtMbndXdFBGOUxVOGFHcmU1c2xjTkVhCmdqRlRPdjV3MEV3Ym5Wa0NBd0VBQVRBTkJna3Foa2lHOXcwQkFRc0ZBQU9DQVFFQWxWMHNtMkVVSmxvOUpiNXkKUE1vMGlDN2J5cHhscUgxcDFNSENXZUdSRTFyK3VRK2N2ZG5FQU5lcWJCL0lkbTZ6ekRwYmFTSUVPRzUrWDc3cwpjUUtPYnEvMkdzUFpKNWlOSy9nN2puMEN6Ym5FQ1F5SUpURkVNczQ3SEI3ZW5yZE5YR3UyWVl1K1p2cjBXckpjCk44d1dhY2FncGRiMlFISURiQVMzbStOTEtCb3RPK3VZMkVRaU9GUVlOeGZmeGZjdkhzY1AxQm9NVFloNWliSSsKcFNncW5TY0g2akNMM1JhMFdjb2ExdnZrQzRyMWlpQUg2ZU1ybzJoTXdHaGZwMllGdHh4U0lVSCtlMTJLaU9PbQpyeE5iQ2ZTRVpwTUNyZktleDBCYlZnbTIrempRZ0lZK3gxWXBOcmVWSURXaW9HQ2NlSFViUnYwS1c4cDc5MEdnCncxMjFjUT09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
    rules:
      - operations: ["*"]
        apiGroups: ["*"]
        apiVersions: ["*"]
        resources: ["services"]
---
apiVersion: v1
data:
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMwekNDQWJzQ0NRQ3VnMk14WTd4TUt6QU5CZ2txaGtpRzl3MEJBUVVGQURBcU1TZ3dKZ1lEVlFRRERCOUIKWkcxcGMzTnBiMjRnUTI5dWRISnZiR3hsY2lCWFpXSm9iMjlySUVOQk1CNFhEVEU1TURrd01qQTVNamMxTlZvWApEVEU1TVRBd01qQTVNamMxTlZvd0xURXJNQ2tHQTFVRUF3d2lkMlZpYUc5dmF5MXpaWEoyWlhJdVoyRjBaWGRoCmVTMTNaV0pvYjI5ckxuTjJZekNDQVNJd0RRWUpLb1pJaHZjTkFRRUJCUUFEZ2dFUEFEQ0NBUW9DZ2dFQkFMaW4KaEdrbWcxdzB3Uk1KSTZrYmpaNU5rbTY0blRUTUxKUkRkWjhMbG9LRnBiUUxZMU9aa2o4VHNRcGZzRjJycHRjcgpWMm1IVTM5bTZpSHNnbFBGK0pFRDdqcDJHeXlQUWJQb21LbzNqOStIK0xBeFJkSWNtUHRQR1R0OUdGc2xyS3JwCnFDaVhRS1hNQ2M2UDlUSUk4UW4wblZNaW9UbkhjMlhvUWJmbC9sUHFobUJKcWVRK1R0L2YwV3EvMWQwT25tcXAKQ1Q2VzhXUGg3bW5xWFFYaE1MZGtvNWtuYWI0Y1pkME9zeWpzQXM2cXVoTjI3Z1J1RFI5cWdmS3NmWnp1TVpqRgp3b3AwZE0zUVdpMGl5RDEvbm5NMFNESXJyQVZoaXRSdDUweFZIZmJLY1ZoOGFqYlFXMG51MFQxcUtyS09pR0hsCmxhbWxVcFZKZkRialhtZlhGbmNDQXdFQUFUQU5CZ2txaGtpRzl3MEJBUVVGQUFPQ0FRRUFTSmw4YXRoWGc0N0QKa1RFK3J3djdoa2pZcW1kZUI5b0RUOHdwekZHSUp5ejlUR0FpTFZOekJUSW1zR2tVYUcwVUZwRkg0RGlQT0lhKwpCVjg5anJCL0RWUU1vZXVHNW5oQUloMDZlRXB6djhob2NjRjRjcTQwK254N2FnVi9NYXlkVHBVK3Fpd3NMMDgwClJ1bWtKQmtUSmdEY0MyZmNVZEpsblBDR3lLZW9YdXB3Y28vWW0wblpIY1ZlNGh5bmpEWS90VHM2ZzByNjJxZWIKOGU5cGJReU1wZGR0d0Z2ZllPRCtuU0JiR09kOGU3R2pWdEpOQlFZR285L2RYcWpkTTJRSXdicm5jNUNCUjdhMwp6R1RDKzdNVTcvNncwa2M3U3ZldCtlWTBlVlYzVk9nVmZDajNhUGZzUStmVXBDU2tJSEJiVTBKZnpnM1JyR3BXCjR1UitGdWZobkE9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
  tls.key: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS0NBUUVBdUtlRWFTYURYRFRCRXdranFSdU5uazJTYnJpZE5Nd3NsRU4xbnd1V2dvV2x0QXRqClU1bVNQeE94Q2wrd1hhdW0xeXRYYVlkVGYyYnFJZXlDVThYNGtRUHVPblliTEk5QnMraVlxamVQMzRmNHNERkYKMGh5WSswOFpPMzBZV3lXc3F1bW9LSmRBcGN3SnpvLzFNZ2p4Q2ZTZFV5S2hPY2R6WmVoQnQrWCtVK3FHWUVtcAo1RDVPMzkvUmFyL1YzUTZlYXFrSlBwYnhZK0h1YWVwZEJlRXd0MlNqbVNkcHZoeGwzUTZ6S093Q3pxcTZFM2J1CkJHNE5IMnFCOHF4OW5PNHhtTVhDaW5SMHpkQmFMU0xJUFgrZWN6UklNaXVzQldHSzFHM25URlVkOXNweFdIeHEKTnRCYlNlN1JQV29xc282SVllV1ZxYVZTbFVsOE51TmVaOWNXZHdJREFRQUJBb0lCQUFPOUtKbzBkRzUyaHY1SwpyaFVyZ0tlVzdJTWZhOWQ0MXVJOXAzRUwvQVV5alpOaXM2VXFzK0poRkxHZ0ZHTWhLYVNydFA1bkJoTExVNnhTCkxLVmptYy9kNDRIOWlEbFR3VUhTVU4wSmVQbE91SU5nekFnZ0doemtraDg1UGpnQ1FFZkpxV1VCQXdjWVpZNXcKTGNmUWxJamVFaDF2MHhIbmJ2ZStSeTVoRXRCQ0k1d3U3bVdGY3c1YXlCVUxEQzNBeHd2eWlpb2h6U2FoSUxQTQpvLzRXN0xIbFlPVFYwNENaRkRCYk1naUd2b0RFNzhvUWVON0EzVlFUcnpkMDF2SVA5Y0JpM3VMM3doa01CK0xGCjJOaVd6c1NzNHRndUVPNmwrb1J0TUNTNTFyMXZVemRlTHRyUG92djMvTmJSQWUvZjZvWVZXemFJWGh4N0J0N1IKcGJMb2NrRUNnWUVBNHpuUERXRi93NkZZZmovY281Q1dER1NYRkxRcEUzalpyQ0VqNDNTaWhVZld6V1hWVDdsMwpMQUZUOS9XR3RsblBmQTBtRXNuYllaZkQ2MFcwZWtMWHpTWUdGQ1o4QW1MS3NXSDlqWXRqdld6K1AzSDRPZG9tCmtubmo4dkRGTEJWRitNZ0NaNVZ0cVNQOHhJcDBUaWV1U08rTXhoM0h6WG1yNGV6ejhZMVgvcUVDZ1lFQTBBbWgKUnBOZFpVY01XbGJZN2RvVWZFYjRScGZ3bkF6dWlYd0dYczNXSm8wT1hBc09JVVJqZTQ4UlJvcEFRTWhONjNUTwpkU0h1U2g1UTRJa1RWR1ZMZXZQaDk3clo5Qmh0Mk40YVRudGpNR21oTWdXckNGQVlOcFptV1JPYm4zUHRyWHVRCmlkMnNiZTZWZktEYkYvdkNwNThnYkFYZWphQWZYaUR2NTNEeGRoY0NnWUVBdFZCZ3RyV3hKS0t2b1haR0VrS0MKYVBzdlR6Yi9lK2s0RUZFVmVSK051N3A2WGNXL2MvRnpkYXJOblJQUFhkekdZcDkvWFFpenhPazhUWlYra1B5YgpoTGl0cXhDV2JiVDFOcHdSbmd1M0YrVkw3OFo2bzNjK3hpejdSdFQzRU5rY3o0cVIyS1AxTUQxbUtsS3N3ZHlLCkJ1c1hzdEw2cHl4S2ltbndzalB1SG1FQ2dZQUE5V3BtMXRzQlVuaCtHaFJaMUQxdjdTdkx0M3VHWEpEazFVdDYKT0Z5YVJPQWlFSEw2T0VSMUYwMnZFNGdFUkdnSGc3eEgwZVkxTlRxT0xsT0dlZ2tGQWdheWk0dmhraE0vZ3BhQQpjaFVjN2YrdUtWU0diMGdOU0Zna1pQQzhwVjRkQklxLzkrT0poaVh1TXhlUFhydWc1aHpTSXB6SjdrajJ1QlFpCjd1Uk45UUtCZ0FNVEhQdG1TeENGREFjdE81NGg0bGZjemhwazFOVVhiU3Z3MHlCMkV2bXRIb1NxYTUwNHFQb2oKdHVaUGx6d0xnV01IMkswK0hjVTAvUlZHN3YzZFZ3NytUaWJ5dnBIVGsvQS9GUG02UW5MUXdiTUl4Y1JaeVNENgpqdklXZzhUL3R2dUZzSjhoUzA1WTNQdjhlN3hoTEtoRDlxSTZDc2lPWjhrNTBTYTR0cmpCCi0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg==
kind: Secret
metadata:
  name: webhook-server-tls
  namespace: gateway-webhook
type: kubernetes.io/tls
